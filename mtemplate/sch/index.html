<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<title>برنامه درسی</title>
</head>
<body>

<main>
    <div class="schedule-container">
        <div class="row">
            <div class="lesson-box" onclick="openDialog(0)">
                <h3 class="lesson-title">زنگ ۱</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
        </div>
        <div class="row">
            <div class="lesson-box" onclick="openDialog(1)">
                <h3 class="lesson-title">زنگ ۲</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
            <div class="lesson-box" onclick="openDialog(2)">
                <h3 class="lesson-title">زنگ ۳</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
        </div>
        <div class="row">
            <div class="lesson-box" onclick="openDialog(3)">
                <h3 class="lesson-title">زنگ ۴</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
        </div>
        <div class="row">
            <div class="lesson-box" onclick="openDialog(4)">
                <h3 class="lesson-title">زنگ ۵</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
            <div class="lesson-box" onclick="openDialog(5)">
                <h3 class="lesson-title">زنگ ۶</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
        </div>
        <div class="row">
            <div class="lesson-box" onclick="openDialog(6)">
                <h3 class="lesson-title">زنگ ۷</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
        </div>
    </div>

    <footer>
        <div class="weekday-info">
            <h3 id="current-day">یکشنبه</h3>
        </div>
        <div class="footer-buttons">
            <button id="next-btn">روز بعدی</button>
            <button id="prev-btn">روز قبلی</button>
        </div>
    </footer>
</main>

<div class="cover" onclick="closeDialog()">
    <div class="card-container" onclick="event.stopPropagation()">
        <div class="card-header">
            <h2>یک کلاس انتخاب کن</h2>
            <button class="close-card-btn" onclick="deleteLesson()" title="لغو انتخاب">لغو انتخاب</button>
        </div>
        <div class="cards-grid">
            <div class="card" id="card1"><h3 id="card-name1">علوم</h3><p id="card-cap1">ظرفیت: ۵ نفر</p></div>
            <div class="card" id="card2"><h3 id="card-name2">ریاضی</h3><p id="card-cap2">ظرفیت: ۳ نفر</p></div>
            <div class="card" id="card3"><h3 id="card-name3">تاریخ</h3><p id="card-cap3">ظرفیت: ۲ نفر</p></div>
            <div class="card" id="card4"><h3 id="card-name4">هنر</h3><p id="card-cap4">ظرفیت: ۱ نفر</p></div>
        </div>
    </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const grade = params.get('grade') || 0;
let currentIndex = 0;
const days = ["شنبه", "یکشنبه", "دوشنبه", "سه‌شنبه", "چهارشنبه"];
const weekdayEl = document.getElementById('current-day');
const lessonBoxes = document.getElementsByClassName('lesson-box');
const lessonInfos = document.getElementsByClassName('lesson-info');
const prevBtn = document.getElementById("prev-btn");
const nextBtn = document.getElementById("next-btn");
let myPlan = Array(days.length).fill(0).map(() => Array(7).fill(null));
let plan = {};
let capacity = {};
let opened_dialog_number = 0;

function persianNumbers(str){ return String(str).replace(/\d/g, d=>'۰۱۲۳۴۵۶۷۸۹'[d]); }

// بروزرسانی جدول برنامه
function updateSchedule(){
  weekdayEl.textContent = days[currentIndex];
  for(let i=0;i<lessonBoxes.length;i++){
    const infoEl = lessonInfos[i];
    const lessonData = myPlan[currentIndex][i];

    if(lessonData){
      infoEl.innerHTML = `<strong>${lessonData}</strong><br><span style="color:#c70101;font-size:0.9em;">قبلاً انتخاب کردی</span>`;
      lessonBoxes[i].style.backgroundColor = "#d1ebe3";
      lessonBoxes[i].style.borderColor = "#09966B";
    } else {
      infoEl.textContent = "---";
      lessonBoxes[i].style.backgroundColor = "#fff6df";
      lessonBoxes[i].style.borderColor = "#FF8300";
    }
  }

  prevBtn.style.display = (currentIndex === 0) ? "none" : "inline-block";
  nextBtn.textContent = (currentIndex === days.length - 1) ? "تمام" : "روز بعدی";
}

function changeDay(delta){
  const newIndex = currentIndex + delta;
  if(newIndex < 0 || newIndex >= days.length) return;
  currentIndex = newIndex;
  updateSchedule();
}

prevBtn.onclick = () => changeDay(-1);
nextBtn.onclick = () => {
  if(currentIndex < days.length - 1) changeDay(1);
  else {
    const incomplete = myPlan.some(d => d.some(x => x === null));
    if(incomplete){
      alert("برنامه کامل نیست — لطفاً همه زنگ‌ها را انتخاب کن.");
    } else {
      parent.postMessage(["main_end", myPlan], "*");
    }
  }
};

function resetCard(card){
  card.style.display = '';
  card.style.backgroundColor = '';
  card.style.border = '';
  card.style.borderColor = '';
  card.style.cursor = 'pointer';
  card.onclick = null;
}

function openDialog(lessonIndex) {
  opened_dialog_number = lessonIndex;
  updateData();
  document.querySelector('.cover').classList.add('active');

  const lessonOptions = plan[currentIndex*7 + lessonIndex] || [];

  // ریست کارت‌ها
  for(let i=0;i<4;i++){
    const card = document.getElementById(`card${i+1}`);
    const nameEl = document.getElementById(`card-name${i+1}`);
    const capEl = document.getElementById(`card-cap${i+1}`);
    resetCard(card);
    nameEl.textContent = '';
    capEl.textContent = '';
    card.style.display = 'none';
  }

  // پر کردن کارت‌ها
  for(let i=0;i<4;i++){
    const card = document.getElementById(`card${i+1}`);
    const nameEl = document.getElementById(`card-name${i+1}`);
    const capEl = document.getElementById(`card-cap${i+1}`);

    if(lessonOptions[i]){
      const name = lessonOptions[i];
      const cap = capacity[currentIndex * 7 + lessonIndex][name];
      nameEl.textContent = name;
      card.style.display = 'flex';

      // بررسی انتخاب قبلی در هر زنگ و روز
      let alreadySelected = false;
      for(let d=0; d<myPlan.length; d++){
        for(let j=0; j<myPlan[d].length; j++){
          if(myPlan[d][j] === name){
            alreadySelected = true;
            break;
          }
        }
        if(alreadySelected) break;
      }

      if(alreadySelected){
        capEl.textContent = "قبلاً انتخاب شده";
        card.style.backgroundColor = "rgba(197,7,7,0.14)";
        card.style.border = "1px solid rgba(197,7,7,1)";
        card.style.cursor = "not-allowed";
        card.onclick = () => alert("این درس قبلاً انتخاب شده!");
      } else if(cap === 0){
        capEl.textContent = persianNumbers("ظرفیت: 0");
        card.style.backgroundColor = "rgba(197,7,7,0.14)";
        card.style.border = "1px solid rgba(197,7,7,1)";
        card.style.cursor = "not-allowed";
        card.onclick = () => alert("ظرفیت این کلاس پر شده است!");
      } else {
        capEl.textContent = persianNumbers("ظرفیت: " + cap);
        card.style.backgroundColor = '';
        card.style.border = "1px solid #ff9c00";
        card.style.cursor = "pointer";
        card.onclick = () => selectLesson(lessonIndex, name);
      }
    }
  }
}

function closeDialog(){
  document.querySelector('.cover').classList.remove('active');
}

function selectLesson(lessonIndex, lessonData) {
  // بررسی تکراری در سایر زنگ‌ها
  for (let d = 0; d < days.length; d++) {
      for (let i = 0; i < 7; i++) {
          if (myPlan[d][i] === lessonData) {
              alert("این درس قبلاً در یک زنگ دیگر انتخاب شده!");
              return;
          }
      }
  }

  myPlan[currentIndex][lessonIndex] = lessonData;
  updateSchedule();
  closeDialog();
}

function deleteLesson() {
  myPlan[currentIndex][opened_dialog_number] = null;
  updateSchedule();
  closeDialog();
}

// گرفتن داده‌ها
function updateData() {
  fetch('https://live-box.storage.c2.liara.space/sch_sch.json')
      .then(res => res.json())
      .then(data => {
          plan = data[parseInt(grade)];
          parent.postMessage(["loading_plan", plan]);
      });
  fetch('https://live-box.storage.c2.liara.space/capacity.json')
      .then(res => res.json())
      .then(data => {
          capacity = data[parseInt(grade)];
      });
  updateSchedule();
}

updateData();
</script>
