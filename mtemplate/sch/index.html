<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="ne.css">
<title>برنامه درسی</title>
</head>
<body>

<main>
    <div class="schedule-container">
        <div class="row">
            <div class="lesson-box" onclick="openDialog(0)">
                <h3 class="lesson-title">زنگ ۱</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
        </div>
        <div class="row">
            <div class="lesson-box" onclick="openDialog(1)">
                <h3 class="lesson-title">زنگ ۲</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
            <div class="lesson-box" onclick="openDialog(2)">
                <h3 class="lesson-title">زنگ ۳</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
        </div>
        <div class="row">
            <div class="lesson-box" onclick="openDialog(3)">
                <h3 class="lesson-title">زنگ ۴</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
        </div>
        <div class="row">
            <div class="lesson-box" onclick="openDialog(4)">
                <h3 class="lesson-title">زنگ ۵</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
            <div class="lesson-box" onclick="openDialog(5)">
                <h3 class="lesson-title">زنگ ۶</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
        </div>
        <div class="row">
            <div class="lesson-box" onclick="openDialog(6)">
                <h3 class="lesson-title">زنگ ۷</h3>
                <p class="lesson-info" dir="rtl">---</p>
            </div>
        </div>
    </div>

    <footer>
        <div class="weekday-info">
            <h3 id="current-day">یکشنبه</h3>
        </div>
        <div class="footer-buttons">
            <button id="next-btn">روز بعدی</button>
            <button id="prev-btn">روز قبلی</button>
        </div>
    </footer>
</main>

<div class="cover" onclick="closeDialog()">
    <div class="card-container" onclick="event.stopPropagation()">
        <div class="card-header">
            <h2>یک کلاس انتخاب کن</h2>
            <button class="close-card-btn" onclick="closeDialog()" title="لغو انتخاب">لغو انتخاب</button>
        </div>
        <div class="cards-grid">
            <div class="card" id="card1"><h3 id="card-name1">علوم</h3><p id="card-cap1">ظرفیت: ۵ نفر</p></div>
            <div class="card" id="card2"><h3 id="card-name2">ریاضی</h3><p id="card-cap2">ظرفیت: ۳ نفر</p></div>
            <div class="card" id="card3"><h3 id="card-name3">تاریخ</h3><p id="card-cap3">ظرفیت: ۲ نفر</p></div>
            <div class="card" id="card4"><h3 id="card-name4">هنر</h3><p id="card-cap4">ظرفیت: ۱ نفر</p></div>
        </div>
    </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const grade = params.get('grade') || 0;
let currentIndex = 0;
const days = ["شنبه","یکشنبه","دوشنبه","سه‌شنبه","چهارشنبه"];
const weekdayEl = document.getElementById('current-day');
const lessonBoxes = document.getElementsByClassName('lesson-box');
const lessonInfos = document.getElementsByClassName('lesson-info');
const prevBtn = document.getElementById("prev-btn");
const nextBtn = document.getElementById("next-btn");
let myPlan = Array(days.length).fill(0).map(() => Array(7).fill(null));
let plan = [];

function persianNumbers(str){
    return str.replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
}

function updateSchedule(){
    weekdayEl.textContent = days[currentIndex];
    for(let i=0;i<lessonBoxes.length;i++){
        const lessonData = myPlan[currentIndex][i];
        lessonInfos[i].textContent = lessonData || "---";
    }

    if(currentIndex === 0){
        prevBtn.style.display = "none";
        nextBtn.textContent = "روز بعدی";
    } else if(currentIndex === days.length - 1){
        prevBtn.style.display = "inline-block";
        nextBtn.textContent = "تمام";
    } else {
        prevBtn.style.display = "inline-block";
        nextBtn.textContent = "روز بعدی";
    }
}

function changeDay(delta){
    const newIndex = currentIndex + delta;
    if(newIndex < 0 || newIndex >= days.length) return;
    currentIndex = newIndex;
    updateSchedule();
}

prevBtn.onclick = () => changeDay(-1);
nextBtn.onclick = () => {
    if(currentIndex < days.length - 1) changeDay(1);
    else {
        let nulled = false;
        for(let i of myPlan){
            for(const item of i){
                if(item === null){nulled = true; break;}
            }
        }
        if(!nulled){ parent.postMessage(["main_end", myPlan]); }
    }
};

function openDialog(lessonIndex){
    const cover = document.querySelector('.cover');
    cover.classList.add('active');

    const lessonOptions = plan[currentIndex*7 + lessonIndex] || [];
    for(let i=0;i<4;i++){
        const card = document.getElementById(`card${i+1}`);
        const nameEl = document.getElementById(`card-name${i+1}`);
        const capEl = document.getElementById(`card-cap${i+1}`);

        if(lessonOptions[i]){
            card.style.display = 'flex';
            nameEl.textContent = lessonOptions[i].split('-')[0];
            capEl.textContent = persianNumbers("ظرفیت: " + lessonOptions[i].split('-')[1]);
            card.onclick = () => selectLesson(lessonIndex, lessonOptions[i]);
        } else {
            card.style.display = 'none';
        }
    }
}

function closeDialog(){
    document.querySelector('.cover').classList.remove('active');
}

function selectLesson(lessonIndex, lessonData){
    for(let d=0; d<days.length; d++){
        for(let i=0; i<7; i++){
            if(myPlan[d][i] && myPlan[d][i].split('-')[0] === lessonData.split('-')[0]){
                alert("این درس قبلاً انتخاب شده!");
                return;
            }
        }
    }
    myPlan[currentIndex][lessonIndex] = lessonData;
    updateSchedule();
    closeDialog();

    let allFilled = myPlan.every(day => day.every(x => x !== null));
    if(allFilled){ parent.postMessage(["main_end", myPlan]); }
}

fetch('https://live-box.storage.c2.liara.space/sch_sch.json')
.then(res => res.json())
.then(data => {
    plan = data[parseInt(grade)];
    parent.postMessage(["loading_plan", plan]);
    updateSchedule();
});
</script>

</body>
</html>
